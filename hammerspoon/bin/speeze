#!/usr/bin/env zsh

# speeze - Freeze Hammerspoon spoon state to lockfile
#
# Captures exact repos and SHAs for reproducibility.
#
# Usage:
#   speeze    # Generate/update ~/.spoons/spoonman lockfile

set -e

SPOONS_DIR="${SPOONS_DIR:-$HOME/.spoons}"
LOCKFILE="$SPOONS_DIR/spoonman"

# -----------------------------------------------------------------------------
# Helper Functions
# -----------------------------------------------------------------------------

die() {
  echo "error: $1" >&2
  exit 1
}

warn() {
  echo "warning: $1" >&2
}

is_git_repo() {
  git -C "$1" rev-parse --git-dir &>/dev/null
}

has_uncommitted_changes() {
  ! git -C "$1" diff-index --quiet HEAD -- 2>/dev/null
}

get_branch() {
  local path="$1"
  local branch
  branch=$(git -C "$path" symbolic-ref --short HEAD 2>/dev/null) || branch="detached"
  echo "$branch"
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------

if [[ ! -d "$SPOONS_DIR" ]]; then
  die "Spoons directory not found: $SPOONS_DIR"
fi

# Collect spoons
spoons=()
for spoon in "$SPOONS_DIR"/*.spoon; do
  [[ -d "$spoon" ]] && spoons+=("$spoon")
done

if [[ ${#spoons[@]} -eq 0 ]]; then
  echo "No spoons found in $SPOONS_DIR"
  exit 0
fi

# Build lockfile content
output="# spoonman - generated by speeze
# Run \`upspoon\` to update, \`speeze\` to regenerate this file
# Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
"

for spoon in "${spoons[@]}"; do
  spoon_name=$(basename "$spoon")
  echo "[$spoon_name]"

  if ! is_git_repo "$spoon"; then
    warn "  Not a git repository, skipping"
    continue
  fi

  if has_uncommitted_changes "$spoon"; then
    warn "  Has uncommitted changes (recording anyway)"
  fi

  repo=$(git -C "$spoon" remote get-url origin 2>/dev/null || echo "unknown")
  sha=$(git -C "$spoon" rev-parse HEAD)
  branch=$(get_branch "$spoon")

  echo "  repo: $repo"
  echo "  sha: ${sha:0:12}"
  echo "  branch: $branch"

  output+="
$spoon_name
  repo: $repo
  sha: $sha
  branch: $branch
"
done

# Write lockfile
echo "$output" > "$LOCKFILE"
echo ""
echo "Lockfile written to: $LOCKFILE"
