# Function to safely remove a git worktree
function wtrm() {
  local current_dir=$(pwd)
  local project_name=$(basename "$current_dir")
  local worktree_base="../${project_name}-worktrees"
  
  # Check if we're in a worktree directory
  if [[ ! "$current_dir" =~ .*-worktrees/.* ]]; then
    echo "Error: Not in a worktree directory. This script should be run from within a worktree."
    return 1
  fi
  
  # Extract branch name from current directory
  local branch=$(basename "$current_dir")
  
  # Check for dirty git files
  if ! git diff --quiet || ! git diff --cached --quiet; then
    echo "Error: Working directory has uncommitted changes. Please commit or stash changes before removing worktree."
    git status --porcelain
    return 1
  fi
  
  # Check for untracked files
  if [ -n "$(git ls-files --others --exclude-standard)" ]; then
    echo "Error: Working directory has untracked files. Please commit or remove them before removing worktree."
    git ls-files --others --exclude-standard
    return 1
  fi
  
  # Get commit count difference from main
  local commit_count=$(git rev-list --count main.."$branch" 2>/dev/null || echo "0")
  
  # Show worktree info and ask for confirmation
  echo "About to remove worktree:"
  echo "  Branch: $branch"
  echo "  Directory: $current_dir"
  echo "  Commits ahead of main: $commit_count"
  echo ""
  
  # Prompt for confirmation
  read -p "Are you sure you want to remove this worktree? (y/N): " -n 1 -r
  echo ""
  
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Worktree removal cancelled."
    return 0
  fi
  
  # Navigate back to main repository
  local main_repo_dir=$(dirname "$worktree_base")
  cd "$main_repo_dir"
  
  # Remove the worktree
  git worktree remove "$current_dir"
  
  if [ $? -eq 0 ]; then
    echo "Successfully removed worktree: $current_dir"
  else
    echo "Failed to remove worktree."
    return 1
  fi
}