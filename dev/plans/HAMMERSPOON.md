# Spoonman: Hammerspoon Spoon Manager

## Background

Hammerspoon is a macOS automation tool that uses Lua. Plugins are called "Spoons" and are conventionally stored in `~/.hammerspoon/Spoons/`. However, the ecosystem has no real package manager - just manual downloads or a bootstrap-required SpoonInstall spoon.

We're building a simple spoon management system:
- Spoons are git clones stored in `~/.spoons/`
- Hammerspoon's `package.path` will be configured to load from there
- A lockfile (`spoonman`) captures exact repos and SHAs for reproducibility

## Directory Structure

```
~/.spoons/
├── EnhancedSpaces.spoon/     # git clone of a spoon repo
├── SomeOther.spoon/          # another spoon
└── spoonman                  # lockfile (generated by speeze)
```

## Commands to Implement

### `upspoon`

Update spoons by pulling latest from their remotes.

```bash
# Update all spoons
upspoon

# Update specific spoon(s)
upspoon EnhancedSpaces.spoon
upspoon EnhancedSpaces.spoon SomeOther.spoon
```

Behavior:
- If no arguments, iterate all `*.spoon` directories in `~/.spoons`
- For each spoon: `git -C <path> pull --ff-only`
- Use `--ff-only` to avoid surprise merges; fail loudly if not fast-forwardable
- Print status for each spoon (already up to date, updated to SHA, or error)
- Exit non-zero if any spoon fails to update

### `speeze`

Freeze current spoon state to the lockfile (like `pip freeze` or `npm shrinkwrap`).

```bash
# Update spoonman lockfile
speeze
```

Behavior:
- Iterate all `*.spoon` directories in `~/.spoons`
- For each, extract:
  - Remote URL: `git -C <path> remote get-url origin`
  - Current SHA: `git -C <path> rev-parse HEAD`
  - Current branch/ref: `git -C <path> symbolic-ref --short HEAD` (or "detached" if detached)
- Write to `~/.spoons/spoonman` in a parseable format

### `spoonman` lockfile format

Use a simple, human-readable format:

```
# spoonman - generated by speeze
# Run `upspoon` to update, `speeze` to regenerate this file

EnhancedSpaces.spoon
  repo: https://github.com/franzbu/EnhancedSpaces.spoon.git
  sha: a1b2c3d4e5f6...
  branch: main

SomeOther.spoon
  repo: https://github.com/someone/SomeOther.spoon.git
  sha: f6e5d4c3b2a1...
  branch: master
```

Alternatively, if you prefer something more machine-friendly, JSON is acceptable:

```json
{
  "generated": "2025-01-07T12:00:00Z",
  "spoons": {
    "EnhancedSpaces.spoon": {
      "repo": "https://github.com/franzbu/EnhancedSpaces.spoon.git",
      "sha": "a1b2c3d4e5f6...",
      "branch": "main"
    }
  }
}
```

Pick whichever you think is cleaner. I slightly prefer the text format for easy `grep`/`awk` but won't complain about JSON.

## Future Commands (do not implement yet, but design with these in mind)

- `inspoon <repo-url>` - clone a spoon into `~/.spoons`
- `unspoon <name>` - remove a spoon
- `respoon` - restore spoons from `spoonman` lockfile (clone missing, checkout exact SHAs)

## Implementation Notes

- Write as shell scripts (bash or zsh, your choice - this is macOS so both are available)
- Scripts should go in a `bin/` directory in this repo
- Include a small `install.sh` that symlinks the scripts to `~/.local/bin` or similar
- Create `~/.spoons` if it doesn't exist
- Handle edge cases:
  - Spoon directory exists but isn't a git repo
  - Spoon has uncommitted changes (warn but continue for `speeze`, refuse to pull for `upspoon`)
  - Remote URL uses SSH vs HTTPS (just capture whatever is configured)
  - No spoons installed yet

## Hammerspoon Integration

After implementing the scripts, provide a snippet for `~/.hammerspoon/init.lua` that:
1. Adds `~/.spoons` to Hammerspoon's spoon search path
2. Example of loading a spoon from there

Something like:
```lua
-- Load spoons from ~/.spoons
package.path = package.path .. ";" .. os.getenv("HOME") .. "/.spoons/?.spoon/init.lua"
```

## Testing

Create a simple test flow I can run:
1. Clone EnhancedSpaces.spoon manually to verify the directory structure
2. Run `speeze` to generate lockfile
3. Run `upspoon` to verify update logic
4. Verify lockfile format is correct

## Deliverables

1. `bin/upspoon` - update script
2. `bin/speeze` - freeze script  
3. `install.sh` - installation helper
4. `README.md` - usage documentation
5. Example `init.lua` snippet for Hammerspoon integration
